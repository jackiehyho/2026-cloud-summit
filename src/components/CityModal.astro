---
---

<div id="city-modal" class="modal" style="display: none;">
	<div class="modal-overlay"></div>
	<div class="modal-content">
		<h2 class="modal-title">Select Your City</h2>
		<p class="modal-description">Choose your location to see city-specific event information</p>
		<div class="modal-options">
			<button class="city-option" data-city="vancouver">
				<span class="city-name">Vancouver</span>
				<span class="city-details">Friday, May 1st, 2026</span>
			</button>
			<button class="city-option" data-city="toronto">
				<span class="city-name">Toronto</span>
				<span class="city-details">Saturday, August 29th, 2026</span>
			</button>
		</div>
	</div>
</div>

<script>
	import { getCityStore } from '../lib/cityStore';
	import { getCityFromUrl } from '../lib/cityContent';

	function initCityModal() {
		const cityStore = getCityStore();
		cityStore.init();

		const modal = document.getElementById('city-modal') as HTMLElement;
		const cityOptions = document.querySelectorAll('.city-option') as NodeListOf<HTMLButtonElement>;
		const modalOverlay = document.querySelector('.modal-overlay') as HTMLElement;

		// Check if user has already selected a city (in this session)
		const CITY_SELECTION_KEY = 'cloud-summit-city-selected';
		const hasSelectedCity = sessionStorage.getItem(CITY_SELECTION_KEY) === 'true';
		
		// Check if city is explicitly in URL
		const urlParams = new URLSearchParams(window.location.search);
		const hasCityInUrl = urlParams.has('city');

		// Show modal if no city selection and no city in URL
		function shouldShowModal(): boolean {
			// If city is explicitly in URL, don't show modal
			if (hasCityInUrl) {
				return false;
			}
			
			// If user has already selected in this session, don't show again
			if (hasSelectedCity) {
				return false;
			}
			
			return true;
		}

		function showModal() {
			if (modal) {
				modal.style.display = 'flex';
				document.body.style.overflow = 'hidden';
			}
		}

		function hideModal() {
			if (modal) {
				modal.style.display = 'none';
				document.body.style.overflow = '';
			}
		}

		function selectCity(city: 'vancouver' | 'toronto') {
			// Ensure store is initialized
			cityStore.init();
			
			// Force update to ensure URL parameter is set even if city is the default
			// This is important when user selects a city from the modal
			cityStore.setCity(city, true, true);
			
			// Mark that user has selected a city
			sessionStorage.setItem(CITY_SELECTION_KEY, 'true');
			
			// Hide modal
			hideModal();
		}

		// Show modal on page load if needed
		if (shouldShowModal()) {
			// Small delay for better UX
			setTimeout(() => {
				showModal();
			}, 300);
		}

		// Handle city option clicks
		cityOptions.forEach(option => {
			option.addEventListener('click', () => {
				const city = option.getAttribute('data-city') as 'vancouver' | 'toronto';
				if (city) {
					selectCity(city);
				}
			});
		});

		// Close modal when clicking overlay
		if (modalOverlay) {
			modalOverlay.addEventListener('click', () => {
				// Don't allow closing without selection - force user to choose
				// Or you can uncomment below to allow closing:
				// hideModal();
			});
		}

		// Prevent closing with Escape key (force selection)
		// Or you can allow it by uncommenting:
		// document.addEventListener('keydown', (e) => {
		//   if (e.key === 'Escape' && modal?.style.display === 'flex') {
		//     hideModal();
		//   }
		// });
	}

	// Run when DOM is ready
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initCityModal);
	} else {
		initCityModal();
	}
</script>

<style>
	.modal {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		z-index: 1000;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 1rem;
	}

	.modal-overlay {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.75);
		backdrop-filter: blur(4px);
	}

	.modal-content {
		position: relative;
		background: white;
		border-radius: 1rem;
		padding: 2.5rem;
		max-width: 500px;
		width: 100%;
		box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
		animation: modalSlideIn 0.3s ease-out;
	}

	@media (prefers-color-scheme: dark) {
		.modal-content {
			background: #1a1a1a;
			border: 1px solid rgba(255, 255, 255, 0.1);
		}
	}

	@keyframes modalSlideIn {
		from {
			opacity: 0;
			transform: translateY(-20px) scale(0.95);
		}
		to {
			opacity: 1;
			transform: translateY(0) scale(1);
		}
	}

	.modal-title {
		font-size: 1.875rem;
		font-weight: 700;
		margin: 0 0 0.5rem 0;
		text-align: center;
		color: inherit;
	}

	.modal-description {
		font-size: 1rem;
		color: rgba(0, 0, 0, 0.7);
		margin: 0 0 2rem 0;
		text-align: center;
		line-height: 1.6;
	}

	@media (prefers-color-scheme: dark) {
		.modal-description {
			color: rgba(255, 255, 255, 0.7);
		}
	}

	.modal-options {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.city-option {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 1.5rem;
		border: 2px solid rgba(0, 0, 0, 0.1);
		border-radius: 0.75rem;
		background: white;
		cursor: pointer;
		transition: all 0.2s;
		text-align: center;
		font-family: inherit;
	}

	@media (prefers-color-scheme: dark) {
		.city-option {
			background: rgba(255, 255, 255, 0.05);
			border-color: rgba(255, 255, 255, 0.2);
		}
	}

	.city-option:hover {
		border-color: rgb(61, 120, 171);
		background: rgba(61, 120, 171, 0.05);
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(61, 120, 171, 0.15);
	}

	.city-option:active {
		transform: translateY(0);
	}

	.city-name {
		font-size: 1.25rem;
		font-weight: 600;
		color: inherit;
		margin-bottom: 0.25rem;
	}

	.city-details {
		font-size: 0.875rem;
		color: rgba(0, 0, 0, 0.6);
	}

	@media (prefers-color-scheme: dark) {
		.city-details {
			color: rgba(255, 255, 255, 0.6);
		}
	}

	@media (max-width: 640px) {
		.modal-content {
			padding: 2rem 1.5rem;
		}

		.modal-title {
			font-size: 1.5rem;
		}

		.city-option {
			padding: 1.25rem;
		}
	}
</style>
